name: CineView Elite Sync

on:
  schedule:
    - cron: '0 * * * *' # Automatically runs every hour
  workflow_dispatch: # Allows you to click "Run workflow" for instant updates

jobs:
  sync-job:
    runs-on: ubuntu-latest
    
    # This is required to allow the bot to save files back to your repo
    permissions:
      contents: write

    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: üì¶ Install Requirements
        run: pip install requests

      - name: üöÄ Run Sync Script
        env:
          # Your Secrets from GitHub Settings
          ABYSS_KEY: ${{ secrets.ABYSS_KEY }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          CUSTOM_API_URL: ${{ secrets.CUSTOM_API_URL }}
          CUSTOM_API_KEY: ${{ secrets.CUSTOM_API_KEY }}
          # Automatically provided by GitHub
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          if [ -f "abyss_bot.py" ]; then
            python abyss_bot.py
          else
            echo "Error: abyss_bot.py not found in the root folder!"
            exit 1
          fi

      - name: üíæ Commit & Push Changes
        run: |
          git config --global user.name "CineView-Bot"
          git config --global user.email "bot@cineview.com"
          
          # Stage all changes (new HTML files, updated index, etc.)
          git add .
          
          # Check if there are actually changes to commit
          if git diff --staged --quiet; then
            echo "No new content found in Abyss."
          else
            git commit -m "Elite Sync: Added new movies & refreshed UI"
            # Push changes back to the main branch
            git push origin HEAD:${{ github.ref }}
          fi
